#!/usr/bin/env fish

# set command 'rpm --query krb5-server > /root/output.txt'
# set command 'krb5kdc > /root/output.txt 2>&1'
set command "iconv -l | grep -E 'CN-?EXT' > /root/output.txt 2>&1"

# only the latest product images for now
set images \
    docker.stackable.tech/stackable/airflow-operator:0.0.0-dev \
    docker.stackable.tech/stackable/commons-operator:0.0.0-dev \
    docker.stackable.tech/stackable/druid-operator:0.0.0-dev \
    docker.stackable.tech/stackable/edc-operator:0.0.0-dev \
    docker.stackable.tech/stackable/hbase-operator:0.0.0-dev \
    docker.stackable.tech/stackable/hdfs-operator:0.0.0-dev \
    docker.stackable.tech/stackable/hello-world-operator:0.0.0-dev \
    docker.stackable.tech/stackable/hive-operator:0.0.0-dev \
    docker.stackable.tech/stackable/kafka-operator:0.0.0-dev \
    docker.stackable.tech/stackable/listener-operator:0.0.0-dev \
    docker.stackable.tech/stackable/nifi-operator:0.0.0-dev \
    docker.stackable.tech/stackable/opa-operator:0.0.0-dev \
    docker.stackable.tech/stackable/secret-operator:0.0.0-dev \
    docker.stackable.tech/stackable/spark-k8s-operator:0.0.0-dev \
    docker.stackable.tech/stackable/superset-operator:0.0.0-dev \
    docker.stackable.tech/stackable/trino-operator:0.0.0-dev \
    docker.stackable.tech/stackable/zookeeper-operator:0.0.0-dev \
    docker.stackable.tech/stackable/airflow-operator:24.3.0 \
    docker.stackable.tech/stackable/commons-operator:24.3.0 \
    docker.stackable.tech/stackable/druid-operator:24.3.0 \
    docker.stackable.tech/stackable/hbase-operator:24.3.0 \
    docker.stackable.tech/stackable/hdfs-operator:24.3.0 \
    docker.stackable.tech/stackable/hello-world-operator:24.3.0 \
    docker.stackable.tech/stackable/hive-operator:24.3.0 \
    docker.stackable.tech/stackable/kafka-operator:24.3.0 \
    docker.stackable.tech/stackable/listener-operator:24.3.0 \
    docker.stackable.tech/stackable/nifi-operator:24.3.0 \
    docker.stackable.tech/stackable/opa-operator:24.3.0 \
    docker.stackable.tech/stackable/secret-operator:24.3.0 \
    docker.stackable.tech/stackable/spark-k8s-operator:24.3.0 \
    docker.stackable.tech/stackable/superset-operator:24.3.0 \
    docker.stackable.tech/stackable/trino-operator:24.3.0 \
    docker.stackable.tech/stackable/zookeeper-operator:24.3.0 \
    docker.stackable.tech/stackable/airflow:2.8.3-stackable0.0.0-dev \
    docker.stackable.tech/stackable/druid:28.0.1-stackable0.0.0-dev \
    docker.stackable.tech/stackable/hadoop:3.3.6-stackable0.0.0-dev \
    docker.stackable.tech/stackable/hbase:2.4.17-stackable0.0.0-dev \
    docker.stackable.tech/stackable/hive:3.1.3-stackable0.0.0-dev \
    docker.stackable.tech/stackable/kafka:3.6.1-stackable0.0.0-dev \
    docker.stackable.tech/stackable/krb5:1.21.1-stackable0.0.0-dev \
    docker.stackable.tech/stackable/nifi:1.25.0-stackable0.0.0-dev \
    docker.stackable.tech/stackable/opa:0.61.0-stackable0.0.0-dev \
    docker.stackable.tech/stackable/spark-k8s:3.5.1-stackable0.0.0-dev \
    docker.stackable.tech/stackable/superset:3.1.0-stackable0.0.0-dev \
    docker.stackable.tech/stackable/tools:1.0.0-stackable0.0.0-dev \
    docker.stackable.tech/stackable/trino:442-stackable0.0.0-dev \
    docker.stackable.tech/stackable/zookeeper:3.9.2-stackable0.0.0-dev \
    docker.stackable.tech/stackable/airflow:2.8.3-stackable24.3.0 \
    docker.stackable.tech/stackable/druid:28.0.1-stackable24.3.0 \
    docker.stackable.tech/stackable/hadoop:3.3.6-stackable24.3.0 \
    docker.stackable.tech/stackable/hbase:2.4.17-stackable24.3.0 \
    docker.stackable.tech/stackable/hive:3.1.3-stackable24.3.0 \
    docker.stackable.tech/stackable/kafka:3.6.1-stackable24.3.0 \
    docker.stackable.tech/stackable/krb5:1.18.2-stackable24.3.0 \
    docker.stackable.tech/stackable/nifi:1.25.0-stackable24.3.0 \
    docker.stackable.tech/stackable/opa:0.61.0-stackable24.3.0 \
    docker.stackable.tech/stackable/spark-k8s:3.5.1-stackable24.3.0 \
    docker.stackable.tech/stackable/superset:3.1.0-stackable24.3.0 \
    docker.stackable.tech/stackable/tools:1.0.0-stackable24.3.0 \
    docker.stackable.tech/stackable/trino:442-stackable24.3.0 \
    docker.stackable.tech/stackable/zookeeper:3.9.2-stackable24.3.0

set releases \
    24.3.0 \
    0.0.0-dev

rm container_output.txt
rm output.txt

for image in $images
    docker pull $image

    docker run --name cve-test --quiet --user root --entrypoint "/bin/sh" $image -c $command
    docker cp cve-test:/root/output.txt container_output.txt
    docker stop cve-test
    docker rm cve-test

    echo $image >> output.txt
    cat container_output.txt >> output.txt
    rm container_output.txt
end
